meta {
  name: Create Token
  type: http
  seq: 1
}

post {
  url: {{host-auth-server}}/authorization-server/token.oauth2
  body: formUrlEncoded
  auth: none
}

headers {
  ~DPoP: {{dpopProof}}
}

body:form-urlencoded {
  client_assertion: {{clientAssertion}}
  client_assertion_type: urn:ietf:params:oauth:client-assertion-type:jwt-bearer
  grant_type: client_credentials
}

script:pre-request {
  const { execSync } = require('child_process');
  
  const dpopScript = bru.getEnvVar('create-dpop-proof-path');
  const assertionScript = bru.getEnvVar('create-client-assertion-path');
  const dpopPrivKey = bru.getEnvVar('dpop-proof-priv-key-path');
  const dpopPubKey = bru.getEnvVar('dpop-proof-pub-key-path');
  const clientAssertionPrivKey = bru.getEnvVar('client-assertion-priv-key-path');
  
  const clientId = bru.getVar('clientId');
  const aud = bru.getEnvVar('auth-server-audience');
  const kid = bru.getVar('kid');
  const purposeId = bru.getVar('purposeId');

  try {
    const dpopProof = execSync(
      `python3 "${dpopScript}" -e=dev -pr="${dpopPrivKey}" -pu="${dpopPubKey}"`,
      { encoding: 'utf-8' }
    ).trim();
    bru.setVar('dpopProof', dpopProof);

    const clientAssertion = execSync(
      `python3 "${assertionScript}" --kid="${kid}" --alg="RS256" --typ="JWT" --issuer="${clientId}" --subject="${clientId}" --audience="${aud}" --purposeId="${purposeId}" --keyPath="${clientAssertionPrivKey}"`,
      { encoding: 'utf-8' }
    ).trim();
    bru.setVar('clientAssertion', clientAssertion);
  } catch (err) {
    bru.setVar('dpopProof', '');
    bru.setVar('clientAssertion', '');
    console.error(err.message);
  }
}